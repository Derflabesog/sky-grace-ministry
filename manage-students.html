<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Students | Sky Grace Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-slate-50 flex min-h-screen">

    <!-- Admin Sidebar Mount Point -->
    <div id="admin-sidebar-mount"></div>
    <script src="admin-sidebar.js" defer></script>

    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col min-w-0">
        
        <!-- Top Bar -->
        <header class="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-8 sticky top-0 z-30">
            <div class="flex items-center gap-4">
                <button class="md:hidden text-slate-500 text-xl" aria-label="Open sidebar"><i class="fas fa-bars"></i></button>
                <h2 class="font-bold text-slate-700 text-lg">Theology School</h2>
            </div>
            <div class="flex items-center gap-4">
                <a href="index.html" class="text-xs font-bold text-slate-400 hover:text-blue-600 transition uppercase tracking-widest">View Live Site <i class="fas fa-external-link-alt ml-1"></i></a>
                <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold text-xs shadow-lg shadow-blue-200">AP</div>
            </div>
        </header>

        <main class="p-8">
            <!-- Success Notification -->
            <div id="successNotification" class="hidden mb-6 bg-green-500 text-white px-6 py-4 rounded-xl shadow-lg flex justify-between items-center transition-all duration-500">
                <div class="flex items-center gap-3">
                    <i class="fas fa-check-circle text-xl"></i>
                    <div>
                        <h4 class="font-bold text-sm uppercase tracking-widest">Success</h4>
                        <p class="text-xs">New student has been successfully enrolled.</p>
                    </div>
                </div>
                <button onclick="document.getElementById('successNotification').classList.add('hidden')" class="text-white/80 hover:text-white" aria-label="Close notification"><i class="fas fa-times"></i></button>
            </div>

            <!-- Page Header -->
            <div class="flex flex-col md:flex-row items-center justify-between mb-8 gap-4">
                <div>
                    <h3 class="text-2xl font-black text-slate-900 uppercase tracking-tight">Student Directory</h3>
                    <p class="text-slate-500 text-sm">Manage enrollments, grades, and academic records.</p>
                </div>
                <div class="flex gap-3">
                    <div class="relative">
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                        <input type="text" id="studentSearch" placeholder="Search students..." class="bg-white border border-slate-200 text-slate-600 pl-10 pr-4 py-3 rounded-xl text-xs font-bold focus:outline-none focus:border-blue-500 transition">
                    </div>
                    <a href="add-student.html" onclick="sessionStorage.removeItem('editStudentId')" class="bg-blue-600 text-white px-6 py-3 rounded-xl text-xs font-black uppercase tracking-widest hover:bg-blue-700 transition shadow-lg shadow-blue-200 flex items-center">
                        <i class="fas fa-user-plus mr-2"></i> Enroll Student
                    </a>
                </div>
            </div>

            <!-- Students Table -->
            <div class="bg-white rounded-3xl border border-slate-200 shadow-xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 border-b border-slate-100">
                            <tr>
                                <th class="py-4 px-6 text-[10px] font-black uppercase text-slate-400 tracking-widest">Student Name</th>
                                <th class="py-4 px-6 text-[10px] font-black uppercase text-slate-400 tracking-widest">Course</th>
                                <th class="py-4 px-6 text-[10px] font-black uppercase text-slate-400 tracking-widest">Enrollment Date</th>
                                <th class="py-4 px-6 text-[10px] font-black uppercase text-slate-400 tracking-widest">Status</th>
                                <th class="py-4 px-6 text-[10px] font-black uppercase text-slate-400 tracking-widest">Progress</th>
                                <th class="py-4 px-6 text-right text-[10px] font-black uppercase text-slate-400 tracking-widest">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody" class="text-sm divide-y divide-slate-50">
                            <!-- Rows will be populated by JS -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div class="p-6 border-t border-slate-100 flex justify-between items-center">
                    <span id="studentCount" class="text-xs font-bold text-slate-400 uppercase tracking-widest">Showing Students</span>
                    <div class="flex gap-2">
                        <button id="prevPageBtn" class="px-4 py-2 border border-slate-200 rounded-lg text-xs font-bold text-slate-500 hover:bg-slate-50 disabled:opacity-50" disabled>Previous</button>
                        <button id="nextPageBtn" class="px-4 py-2 border border-slate-200 rounded-lg text-xs font-bold text-slate-500 hover:bg-slate-50 disabled:opacity-50">Next</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- View Student Modal -->
    <div id="viewModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-slate-900/50 backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-2xl w-full mx-4 transform transition-all scale-100 relative">
            <button onclick="closeViewModal()" class="absolute top-6 right-6 text-slate-400 hover:text-slate-600 transition" aria-label="Close modal"><i class="fas fa-times text-xl"></i></button>
            
            <div class="flex items-center gap-6 mb-8 border-b border-slate-100 pb-6">
                <div class="w-20 h-20 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-2xl font-black" id="viewInitials">JD</div>
                <div>
                    <h3 class="text-2xl font-black text-slate-900 uppercase tracking-tight" id="viewName">John Doe</h3>
                    <p class="text-slate-500 text-sm font-bold" id="viewId">ID: TS-2026-001</p>
                    <span class="inline-block mt-2 px-3 py-1 bg-green-100 text-green-600 text-[10px] font-black rounded-full uppercase tracking-wide" id="viewStatus">Active</span>
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-8">
                <div>
                    <h4 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4">Personal Information</h4>
                    <div class="space-y-3 text-sm">
                        <div>
                            <p class="text-slate-400 text-xs">Email Address</p>
                            <p class="font-bold text-slate-700" id="viewEmail">john@example.com</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-xs">Phone Number</p>
                            <p class="font-bold text-slate-700" id="viewPhone">+264 81 123 4567</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-xs">Date of Birth</p>
                            <p class="font-bold text-slate-700" id="viewDob">Jan 15, 1990</p>
                        </div>
                    </div>
                </div>

                <div>
                    <h4 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4">Academic Record</h4>
                    <div class="space-y-3 text-sm">
                        <div>
                            <p class="text-slate-400 text-xs">Enrolled Course</p>
                            <p class="font-bold text-slate-700" id="viewCourse">Foundations of Grace</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-xs">Branch / Campus</p>
                            <p class="font-bold text-slate-700" id="viewBranch">Okahandja HQ</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-xs">Enrollment Date</p>
                            <p class="font-bold text-slate-700" id="viewEnrollDate">Jan 15, 2026</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-xs">Progress</p>
                            <div class="w-full h-2 bg-slate-100 rounded-full overflow-hidden mt-1">
                                <div class="bg-blue-500 h-full w-[45%]" id="viewProgressBar"></div>
                            </div>
                            <p class="text-xs font-bold text-blue-600 mt-1" id="viewProgressText">45% Complete</p>
                        </div>
                        <div class="pt-4">
                            <button onclick="downloadTranscript()" class="w-full bg-slate-900 text-white py-3 rounded-xl text-xs font-black uppercase tracking-widest hover:bg-blue-600 transition shadow-lg flex items-center justify-center gap-2">
                                <i class="fas fa-file-download"></i> Download Transcript
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-slate-900/50 backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full mx-4 transform transition-all scale-100">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h3 class="text-xl font-black text-slate-900 uppercase tracking-tight">Confirm Deletion</h3>
                <p class="text-slate-500 text-sm mt-2">Are you sure you want to remove this student? This action cannot be undone.</p>
            </div>
            <div class="flex gap-3">
                <button onclick="closeDeleteModal()" class="flex-1 px-4 py-3 border border-slate-200 rounded-xl text-xs font-bold text-slate-500 hover:bg-slate-50 transition uppercase tracking-widest">Cancel</button>
                <button onclick="confirmDelete()" class="flex-1 px-4 py-3 bg-red-500 text-white rounded-xl text-xs font-black hover:bg-red-600 transition uppercase tracking-widest shadow-lg shadow-red-200">Delete</button>
            </div>
        </div>
    </div>

    <script>
        let studentToDeleteId = null;
        let currentPage = 1;
        const itemsPerPage = 5;
        let currentFilteredStudents = [];

        document.addEventListener('DOMContentLoaded', function() {
            // Check for success message from add-student page
            if (sessionStorage.getItem('studentAdded')) {
                const notification = document.getElementById('successNotification');
                notification.classList.remove('hidden');
                sessionStorage.removeItem('studentAdded');
                setTimeout(() => notification.classList.add('hidden'), 5000); // Auto hide after 5s
            } else if (sessionStorage.getItem('studentUpdated')) {
                const notification = document.getElementById('successNotification');
                notification.querySelector('h4').innerText = 'Updated';
                notification.querySelector('p').innerText = 'Student details updated successfully.';
                notification.classList.remove('hidden');
                sessionStorage.removeItem('studentUpdated');
                setTimeout(() => notification.classList.add('hidden'), 5000);
            }

            let students = JSON.parse(localStorage.getItem('theologyStudents')) || [];

            // Seed default data if empty (for demonstration)
            if (students.length === 0) {
                students = [
                    { id: 'TS-2026-001', name: 'John Doe', course: 'Foundations of Grace', enrollDate: '2026-01-15', status: 'active', progress: 45 },
                    { id: 'TS-2026-002', name: 'Sarah Miller', course: 'Prophetic Ministry', enrollDate: '2026-01-18', status: 'pending', progress: 0 }
                ];
                localStorage.setItem('theologyStudents', JSON.stringify(students));
            }

            currentFilteredStudents = students;
            renderStudents();

            // Search Filter Logic
            document.getElementById('studentSearch').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const allStudents = JSON.parse(localStorage.getItem('theologyStudents')) || [];
                currentFilteredStudents = allStudents.filter(student => 
                    student.name.toLowerCase().includes(searchTerm) || 
                    student.id.toLowerCase().includes(searchTerm)
                );
                currentPage = 1;
                renderStudents();
            });

            // Pagination Listeners
            document.getElementById('prevPageBtn').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderStudents();
                }
            });

            document.getElementById('nextPageBtn').addEventListener('click', () => {
                const totalPages = Math.ceil(currentFilteredStudents.length / itemsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderStudents();
                }
            });
        });

        function renderStudents() {
            const students = currentFilteredStudents;
            const tableBody = document.getElementById('studentsTableBody');
            tableBody.innerHTML = '';

            const totalItems = students.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            
            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginatedStudents = students.slice(start, end);

            const startDisplay = totalItems > 0 ? start + 1 : 0;
            const endDisplay = Math.min(end, totalItems);
            document.getElementById('studentCount').innerText = `Showing ${startDisplay}-${endDisplay} of ${totalItems} Students`;

            document.getElementById('prevPageBtn').disabled = currentPage === 1;
            document.getElementById('nextPageBtn').disabled = currentPage >= totalPages || totalPages === 0;

            paginatedStudents.forEach(student => {
                const initials = student.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                const statusColor = student.status === 'active' ? 'bg-green-100 text-green-600' : 
                                  (student.status === 'pending' ? 'bg-amber-100 text-amber-600' : 'bg-slate-100 text-slate-500');
                
                const row = `
                    <tr class="hover:bg-blue-50/30 transition group">
                        <td class="py-5 px-6">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center text-slate-500 font-bold text-xs">${initials}</div>
                                <div>
                                    <span class="font-bold text-slate-900 block">${student.name}</span>
                                    <span class="text-xs text-slate-400">ID: ${student.id}</span>
                                </div>
                            </div>
                        </td>
                        <td class="py-5 px-6 text-slate-600 font-medium">${student.course}</td>
                        <td class="py-5 px-6 text-slate-500">${student.enrollDate}</td>
                        <td class="py-5 px-6">
                            <span class="px-3 py-1 ${statusColor} text-[10px] font-black rounded-full uppercase tracking-wide">${student.status}</span>
                        </td>
                        <td class="py-5 px-6">
                            <div class="w-24 h-1.5 bg-slate-100 rounded-full overflow-hidden">
                                <div class="bg-blue-500 h-full" style="width: ${student.progress}%"></div>
                            </div>
                            <span class="text-[10px] text-slate-400 font-bold mt-1 block">${student.progress}% Complete</span>
                        </td>
                        <td class="py-5 px-6 text-right space-x-2">
                            <button class="w-8 h-8 rounded-lg bg-slate-100 text-slate-500 hover:bg-blue-500 hover:text-white transition" aria-label="View Details" title="View Details" onclick="viewStudent('${student.id}')"><i class="fas fa-eye"></i></button>
                            <button class="w-8 h-8 rounded-lg bg-slate-100 text-slate-500 hover:bg-blue-500 hover:text-white transition" aria-label="Edit" title="Edit" onclick="editStudent('${student.id}')"><i class="fas fa-edit"></i></button>
                            <button class="w-8 h-8 rounded-lg bg-slate-100 text-slate-500 hover:bg-red-500 hover:text-white transition" aria-label="Delete" title="Delete" onclick="deleteStudent('${student.id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
        }

        function editStudent(id) {
            sessionStorage.setItem('editStudentId', id);
            window.location.href = 'add-student.html';
        }

        function viewStudent(id) {
            const students = JSON.parse(localStorage.getItem('theologyStudents')) || [];
            const student = students.find(s => s.id === id);
            
            if (student) {
                const initials = student.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                
                document.getElementById('viewInitials').innerText = initials;
                document.getElementById('viewName').innerText = student.name;
                document.getElementById('viewId').innerText = `ID: ${student.id}`;
                
                const statusSpan = document.getElementById('viewStatus');
                statusSpan.innerText = student.status;
                statusSpan.className = `inline-block mt-2 px-3 py-1 text-[10px] font-black rounded-full uppercase tracking-wide ${
                    student.status === 'active' ? 'bg-green-100 text-green-600' : 
                    (student.status === 'pending' ? 'bg-amber-100 text-amber-600' : 'bg-slate-100 text-slate-500')
                }`;

                document.getElementById('viewEmail').innerText = student.email;
                document.getElementById('viewPhone').innerText = student.phone;
                document.getElementById('viewDob').innerText = student.dob;
                
                document.getElementById('viewCourse').innerText = student.course;
                document.getElementById('viewBranch').innerText = student.branch;
                document.getElementById('viewEnrollDate').innerText = student.enrollDate;
                
                document.getElementById('viewProgressBar').style.width = `${student.progress}%`;
                document.getElementById('viewProgressText').innerText = `${student.progress}% Complete`;

                // Store ID for transcript
                document.getElementById('viewModal').dataset.currentStudentId = id;

                document.getElementById('viewModal').classList.remove('hidden');
            }
        }

        function closeViewModal() {
            document.getElementById('viewModal').classList.add('hidden');
        }

        function downloadTranscript() {
            const id = document.getElementById('viewModal').dataset.currentStudentId;
            const students = JSON.parse(localStorage.getItem('theologyStudents')) || [];
            const student = students.find(s => s.id === id);

            if (student && window.jspdf) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Header
                doc.setFontSize(20);
                doc.setTextColor(15, 23, 42);
                doc.text("Sky Grace School of Theology", 20, 20);
                
                doc.setFontSize(12);
                doc.setTextColor(100);
                doc.text("Official Academic Transcript", 20, 30);
                doc.setLineWidth(0.5);
                doc.line(20, 35, 190, 35);

                // Student Details
                doc.setFontSize(10);
                doc.setTextColor(0);
                doc.text(`Student Name: ${student.name}`, 20, 50);
                doc.text(`Student ID: ${student.id}`, 20, 60);
                doc.text(`Course: ${student.course}`, 20, 70);
                doc.text(`Enrollment Date: ${student.enrollDate}`, 20, 80);
                doc.text(`Status: ${student.status.toUpperCase()}`, 20, 90);
                doc.text(`Academic Progress: ${student.progress}%`, 20, 100);

                // Footer
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text("This document is electronically generated by Sky Grace Admin System.", 20, 280);

                doc.save(`${student.name.replace(/\s+/g, '_')}_Transcript.pdf`);
            } else {
                alert("Unable to generate transcript. Please try again.");
            }
        }

        function deleteStudent(id) {
            studentToDeleteId = id;
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.add('hidden');
            studentToDeleteId = null;
        }

        function confirmDelete() {
            if (studentToDeleteId) {
                let students = JSON.parse(localStorage.getItem('theologyStudents')) || [];
                students = students.filter(s => s.id !== studentToDeleteId);
                localStorage.setItem('theologyStudents', JSON.stringify(students));
                currentFilteredStudents = currentFilteredStudents.filter(s => s.id !== studentToDeleteId);
                renderStudents();
                closeDeleteModal();
            }
        }
    </script>
</body>
</html>